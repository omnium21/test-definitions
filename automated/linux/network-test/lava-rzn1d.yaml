job_name: SE rzn1d network-test link-settings
timeouts:
  job:
    minutes: 1800
  action:
    minutes: 120
  connection:
    minutes: 20
priority: medium
visibility: public


protocols:
  lava-multinode:
    roles:
      server:
        device_type: rzn1d
        count: 1
        timeout:
          minutes: 30
      client:
        device_type: rzn1d
        count: 1
        timeout:
          minutes: 30



actions:
####################
# Deploy QSPI images
####################
- deploy:
    role:
    - server
    - client
    namespace: dfu-firmware
    to: tmpfs
    images:
      sf_fsbl:
        image_arg: --alt sf_fsbl --download {sf_fsbl}
        url: https://releases.linaro.org/members/schneider/openembedded/2020.09-dunfell/rzn1d-5.4/rzn1d-snarc-fsbl-fip-linaro-rel-2020.09-dunfell-rc2-internal-dirty.spkg
      sf_trustedfw:
        image_arg: --alt sf_trustedfw --download {sf_trustedfw}
        url: https://releases.linaro.org/members/schneider/openembedded/2020.09-dunfell/rzn1d-5.4/optee/optee-os-linaro-rel-2020.09-dunfell-rc2-internal-dirty.itb
      sf_uboot0:
        image_arg: --alt sf_uboot0 --download {sf_uboot0}
        url: https://releases.linaro.org/members/schneider/openembedded/2020.09-dunfell/rzn1d-5.4/ubootfitImage-linaro-rel-2020.09-dunfell-rc2-internal-dirty-rzn1d.itb
      sf_uboot1:
        image_arg: --alt sf_uboot1 --download {sf_uboot1}
        url: https://releases.linaro.org/members/schneider/openembedded/2020.09-dunfell/rzn1d-5.4/ubootfitImage-linaro-rel-2020.09-dunfell-rc2-internal-dirty-rzn1d.itb
- command:
    role:
    - server
    - client
    namespace: dfu-firmware
    name: set_boot_to_nand
- boot:
    role:
    - server
    - client
    namespace: dfu-firmware
    method: dfu
    timeout:
      minutes: 10
- command:
    role:
    - server
    - client
    namespace: test
    name: set_boot_to_qspi

###################
# dip-image-dev.wic
###################
- deploy:
    role:
    - server
    - client
    namespace: test-wic
    timeout:
      minutes: 100
    to: flasher
    images:
      image:
        url: https://releases.linaro.org/members/schneider/openembedded/2020.09-dunfell/rzn1d-5.4/dip-image-dev-rzn1-snarc-linaro-rel-2020.09-dunfell-rc2-internal-dirty-130.rootfs.wic.bz2
        compression: bz2
      layout:
        url: https://releases.linaro.org/members/schneider/openembedded/2020.09-dunfell/rzn1d-5.4/dip-image-dev-rzn1-snarc-linaro-rel-2020.09-dunfell-rc2-internal-dirty-130.rootfs.wic.bmap
- boot:
    role:
    - server
    - client
    namespace: test-wic
    connection-namespace: dfu-firmware
    timeout:
      minutes: 10
    method: u-boot
    commands:
    - mmc rescan
    - fatload mmc 0:1 80008000 zimage-rzn1-snarc.bin
    - if test -e mmc 0:1 zImage-rzn1d400-snarc-bestla.dtb; then fatload mmc 0:1 80f00000
      zImage-rzn1d400-snarc-bestla.dtb; else fatload mmc 0:1 80f00000 rzn1d400-snarc-bestla.dtb;
      fi;
    - setenv bootargs console=ttyS0,115200 root=/dev/mmcblk0p2 rw rootwait coherent_pool=2M
    - bootz 80008000 - 80f00000
    auto_login:
      login_prompt: 'login:'
      username: root
    prompts:
    - 'root@snarc-soca9:'
    - 'root@rzn1-snarc:'
    transfer_overlay:
      download_command: udhcpc -i eth1 -n || udhcpc -i eth0 -n; wget
      unpack_command: tar --touch -C / -xzf




#################################
# Daemon
#################################
- test:
    namespace: test-wic
    role:
    - server
    timeout:
      minutes: 300
    definitions:
    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: daemon
      parameters:
        CMD: daemon
        ETH: eth1


#################################
# Client
#################################

- command:
    namespace: test-wic
    role:
    - client
    name: j21_off

- command:
    namespace: test-wic
    role:
    - client
    name: j22_on

- test:
    namespace: test-wic
    role:
    - client
    timeout:
      minutes: 30
    definitions:


    #################################
    #  configure-interface
    #################################
    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: configure-interface
      parameters:
        CMD: configure-interface
        ETH: lan0
        SWITCH_IF: eth0
        EXPECTED_RESULT: pass



    #################################
    #  PING - before we mess with link-settings
    #################################
    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: link-settings-ping
      parameters:
        CMD: ping-request
        ETH: lan0
        EXPECTED_RESULT: pass




    #################################
    #  link-settings off/100/full/1500
    #################################
    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: link-settings-100-full
      parameters:
        CMD: link-settings
        ETH: lan0
        AUTONEG: "off"
        LINKSPEED: 100
        DUPLEX: full
        MTU: 1500


    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: link-settings-ping-1
      parameters:
        CMD: ping-request
        ETH: lan0
        EXPECTED_RESULT: pass



    #################################
    #  link-settings off/100/half/1500
    #################################
    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: link-settings-100-half
      parameters:
        CMD: link-settings
        ETH: lan0
        AUTONEG: "off"
        LINKSPEED: 100
        DUPLEX: half
        MTU: 1500


    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: link-settings-ping-2
      parameters:
        CMD: ping-request
        ETH: lan0
        EXPECTED_RESULT: pass



    #################################
    #  link-settings off/100/full/1500
    #################################
    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: link-settings-100-full-2
      parameters:
        CMD: link-settings
        ETH: lan0
        AUTONEG: "off"
        LINKSPEED: 100
        DUPLEX: full
        MTU: 1500


    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: link-settings-ping-3
      parameters:
        CMD: ping-request
        ETH: lan0
        EXPECTED_RESULT: pass




    #################################
    #  link-settings on/?/?/1500
    #################################
    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: link-settings-autoneg
      parameters:
        CMD: link-settings
        ETH: lan0
        AUTONEG: "on"
        MTU: 1500


    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: link-settings-ping-4
      parameters:
        CMD: ping-request
        ETH: lan0
        EXPECTED_RESULT: pass




    #################################
    # Switch port J22 (lan0) off
    #################################
- command:
    namespace: test-wic
    role:
    - client
    name: j22_off

- test:
    namespace: test-wic
    role:
    - client
    timeout:
      minutes: 10
    interactive:
    - name: sleep-2
      prompts: ["root@snarc-soca9", "root@rzn1-snarc"]
      script:
      - command: sleep 5


    #################################
    # Check that ping fails
    #################################
- test:
    namespace: test-wic
    role:
    - client
    timeout:
      minutes: 300
    definitions:

    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: off-ping-1
      parameters:
        CMD: ping-request
        ETH: lan0
        EXPECTED_RESULT: fail



    #################################
    # Switch port J22 (lan0) back on again
    #################################
- command:
    namespace: test-wic
    role:
    - client
    name: j22_on

- test:
    namespace: test-wic
    role:
    - client
    timeout:
      minutes: 10
    interactive:
    - name: sleep-2
      prompts: ["root@snarc-soca9", "root@rzn1-snarc"]
      script:
      - command: sleep 5


    #################################
    # Check that ping succeeds
    #################################
- test:
    namespace: test-wic
    role:
    - client
    timeout:
      minutes: 300
    definitions:

    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: on-ping-1
      parameters:
        CMD: ping-request
        ETH: lan0
        EXPECTED_RESULT: pass





- test:
    namespace: test-wic
    role:
    - client
    timeout:
      minutes: 300
    definitions:

    #################################
    # SCP from Target to Host
    #################################
    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: scp-1
      parameters:
        CMD: scp-target-to-host
        ETH: lan0




    #################################
    # SCP from Host to Target
    #################################
    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: scp-2
      parameters:
        CMD: scp-host-to-target
        ETH: lan0






    #################################
    # SSH from Host to Target
    #################################
    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: ssh-1
      parameters:
        CMD: ssh-host-to-target
        ETH: lan0








    #################################
    #  Finished
    #################################
    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: finished
      parameters:
        ETH: lan0
        CMD: finished
