job_name: SE soca9 network-test link-settings
timeouts:
  job:
    minutes: 1800
  action:
    minutes: 120
  connection:
    minutes: 20
priority: medium
visibility: public


protocols:
  lava-multinode:
    roles:
      server:
        device_type: soca9
        count: 1
        timeout:
          minutes: 30
      client:
        device_type: soca9
        count: 1
        timeout:
          minutes: 30



actions:
##################
# Deploy WIC image
##################
- deploy:
    timeout:
      minutes: 20
    to: flasher
    images:
      image:
        url: https://releases.linaro.org/members/schneider/openembedded/2020.09-dunfell/soca9-5.4/dip-image-dev-snarc-soca9-linaro-rel-2020.09-dunfell-rc2-internal-dirty-130.rootfs.wic.bz2
        compression: bz2
      layout:
        url: https://releases.linaro.org/members/schneider/openembedded/2020.09-dunfell/soca9-5.4/dip-image-dev-snarc-soca9-linaro-rel-2020.09-dunfell-rc2-internal-dirty-130.rootfs.wic.bmap


##################
# all ports off
##################
- command:
    role:
    - server
    - client
    name: j17_off

- command:
    role:
    - server
    - client
    name: j21_off

- command:
    role:
    - server
    - client
    name: j22_off

- command:
    role:
    - server
    - client
    name: j23_off

- command:
    role:
    - server
    - client
    name: j24_off

###################
# dip-image-dev.wic
###################
# We already flashed the SDcard WIC image in the deploy step at the begging of this test run
- boot:
    role:
    - server
    - client
    timeout:
      minutes: 10
    method: u-boot
    commands:
    - run linux_sd
    auto_login:
      login_prompt: 'login:'
      username: root
    prompts:
    - 'root@snarc-soca9:'
    - 'root@rzn1-snarc:'
    transfer_overlay:
      download_command: udhcpc -i eth1 -n || udhcpc -i eth0 -n; wget
      unpack_command: tar --touch -C / -xzf




#################################
# Daemon
#################################
- command:
    role:
    - server
    name: j22_on

- test:
    role:
    - server
    timeout:
      minutes: 300
    definitions:
    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: daemon
      parameters:
        CMD: daemon
        ETH: eth1


#################################
# Client
#################################

- command:
    role:
    - client
    name: j22_on

- test:
    role:
    - client
    timeout:
      minutes: 30
    definitions:


    #################################
    #  configure-interface
    #################################
    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: configure-interface
      parameters:
        CMD: configure-interface
        ETH: lan0
        SWITCH_IF: eth0
        EXPECTED_RESULT: pass



    #################################
    #  PING - before we mess with link-settings
    #################################
    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: link-settings-ping
      parameters:
        CMD: ping-request
        ETH: lan0
        EXPECTED_RESULT: pass




    #################################
    #  link-settings off/100/full/1500
    #################################
    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: link-settings-100-full
      parameters:
        CMD: link-settings
        ETH: lan0
        AUTONEG: "off"
        LINKSPEED: 100
        DUPLEX: full
        MTU: 1500


    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: link-settings-ping-1
      parameters:
        CMD: ping-request
        ETH: lan0
        EXPECTED_RESULT: pass



    #################################
    #  link-settings off/100/half/1500
    #################################
    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: link-settings-100-half
      parameters:
        CMD: link-settings
        ETH: lan0
        AUTONEG: "off"
        LINKSPEED: 100
        DUPLEX: half
        MTU: 1500


    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: link-settings-ping-2
      parameters:
        CMD: ping-request
        ETH: lan0
        EXPECTED_RESULT: pass



    #################################
    #  link-settings off/100/full/1500
    #################################
    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: link-settings-100-full-2
      parameters:
        CMD: link-settings
        ETH: lan0
        AUTONEG: "off"
        LINKSPEED: 100
        DUPLEX: full
        MTU: 1500


    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: link-settings-ping-3
      parameters:
        CMD: ping-request
        ETH: lan0
        EXPECTED_RESULT: pass




    #################################
    #  link-settings on/?/?/1500
    #################################
    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: link-settings-autoneg
      parameters:
        CMD: link-settings
        ETH: lan0
        AUTONEG: "on"
        MTU: 1500


    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: link-settings-ping-4
      parameters:
        CMD: ping-request
        ETH: lan0
        EXPECTED_RESULT: pass




    #################################
    # Switch port J22 (lan0) off
    #################################
- command:
    role:
    - client
    name: j22_off

- test:
    role:
    - client
    timeout:
      minutes: 10
    interactive:
    - name: sleep-2
      prompts: ["root@snarc-soca9", "root@rzn1-snarc"]
      script:
      - command: sleep 5


    #################################
    # Check that ping fails
    #################################
- test:
    role:
    - client
    timeout:
      minutes: 300
    definitions:

    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: off-ping-1
      parameters:
        CMD: ping-request
        ETH: lan0
        EXPECTED_RESULT: fail



    #################################
    # Switch port J22 (lan0) back on again
    #################################
- command:
    role:
    - client
    name: j22_on

- test:
    role:
    - client
    timeout:
      minutes: 10
    interactive:
    - name: sleep-2
      prompts: ["root@snarc-soca9", "root@rzn1-snarc"]
      script:
      - command: sleep 5


    #################################
    # Check that ping succeeds
    #################################
- test:
    role:
    - client
    timeout:
      minutes: 300
    definitions:

    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: on-ping-1
      parameters:
        CMD: ping-request
        ETH: lan0
        EXPECTED_RESULT: pass





- test:
    role:
    - client
    timeout:
      minutes: 300
    definitions:

    #################################
    # SCP from Target to Host
    #################################
    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: scp-1
      parameters:
        CMD: scp-target-to-host
        ETH: lan0




    #################################
    # SCP from Host to Target
    #################################
    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: scp-2
      parameters:
        CMD: scp-host-to-target
        ETH: lan0






    #################################
    # SSH from Host to Target
    #################################
    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: ssh-1
      parameters:
        CMD: ssh-host-to-target
        ETH: lan0








    #################################
    #  Finished
    #################################
    - repository: https://github.com/omnium21/test-definitions.git
      branch: ethernet
      from: git
      path: automated/linux/network-test/network-test.yaml
      name: finished
      parameters:
        ETH: lan0
        CMD: finished


    #################################
    # Reset the port status
    #################################
- command:
    role:
    - client
    name: j21_on

- command:
    role:
    - client
    name: j22_off
