device_type: soca9
job_name: SoCA9 network port check
timeouts:
  job:
    minutes: 180
  action:
    minutes: 120
  connection:
    minutes: 20
priority: medium
visibility: public
actions:
##################
# Deploy WIC image
##################
- deploy:
    timeout:
      minutes: 20
    to: flasher
    images:
      image:
        url: https://releases.linaro.org/members/schneider/openembedded/2020.09-dunfell/soca9-5.4/dip-image-dev-snarc-soca9-linaro-rel-2020.09-dunfell-rc2-internal-dirty-130.rootfs.wic.bz2
        compression: bz2
      layout:
        url: https://releases.linaro.org/members/schneider/openembedded/2020.09-dunfell/soca9-5.4/dip-image-dev-snarc-soca9-linaro-rel-2020.09-dunfell-rc2-internal-dirty-130.rootfs.wic.bmap


##################
# all ports off - except J21
##################
- command:
    name: j17_off

- command:
    name: j21_on

- command:
    name: j22_off

- command:
    name: j23_off

- command:
    name: j24_off


###################
# dip-image-dev.wic
###################
# We already flashed the SDcard WIC image in the deploy step at the begging of this test run
- boot:
    timeout:
      minutes: 10
    method: u-boot
    commands:
    - run linux_sd
    auto_login:
      login_prompt: 'login:'
      username: root
    prompts:
    - 'root@snarc-soca9:'
    - 'root@rzn1-snarc:'
    transfer_overlay:
      download_command: udhcpc -i eth1 -n || udhcpc -i eth0 -n; wget
      unpack_command: tar --touch -C / -xzf


#################################
# Turn off all Yepkit USB devices
#################################
- test:
    timeout:
      minutes: 60
    definitions:
    - from: inline
      repository:
        metadata:
          format: Lava-Test Test Definition 1.0
          name: yepkit-down-all
          description: yepkit test
        run:
          steps:
          - git clone https://github.com/Yepkit/ykush
          - cd ykush
          - make
          - bin/ykushcmd -d a
          - sleep 3
      name: yepkit-down-all
      path: inline/yepkit-test.yaml


#############################
# We're finished with J21 now
#############################
- command:
    role:
    - daemon
    - dut
    name: j21_off


##########################
# Disable network ports
##########################
- test:
    timeout:
      minutes: 10
    interactive:
    - name: networkmanager
      prompts: [root@snarc-soca9, root@rzn1-snarc]
      script:
      - command: ifconfig eth0 down
      - command: ifconfig eth1 down
      - command: ifconfig lan0 down
      - command: ifconfig lan1 down
      - command: ifconfig lan2 down
      - command: sleep 10
      - command: ip addr show


##################
# J17
##################
- command:
    name: j17_on

- test:
    timeout:
      minutes: 30
    interactive:
    - name: j17
      prompts: [root@snarc-soca9, root@rzn1-snarc]
      script:
      - command: ETH=eth2
      - command: ifconfig -a
      - command: ip addr show
      - command: ip addr show ${ETH}
      - command: nmcli -c no -t connection show
      - command: 'nmcli -c no -t connection show | grep ${ETH} | cut -d: -f1'
      - command: 'ID=$(nmcli -c no -t connection show | grep ${ETH} | cut -d: -f1)'
      - command: echo ID=${ID}
      - command: nmcli -c no -t connection show id "${ID}" | grep autoconn
      - command: nmcli device
      - command: nmcli -c no -t device
      - command: nmcli -c no -t device show
      - command: nmcli -c no -t device show ${ETH}
      - command: nmcli device set ${ETH} managed yes autoconnect yes
      - command: ifconfig ${ETH} up
      - command: ""
      - command: ""
      - command: sleep 10
      - command: ""
      - command: ""
      - command: ip addr show ${ETH}
      - command: ""
      - command: ""
      - command: nmcli -c no -t device show ${ETH}
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: echo "1 minute..."
      - command: ip addr show ${ETH}
      - command: nmcli -c no -t device show ${ETH}
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: echo "2 minutes..."
      - command: ip addr show ${ETH}
      - command: nmcli -c no -t device show ${ETH}
      - command: ping -I ${ETH} -c 3 10.0.0.2
      - command: ping -I ${ETH} -c 3 10.0.33.20
      - command: ping -I ${ETH} -c 3 10.128.64.1
      - command: ping -I ${ETH} -c 3 github.com
      - command: ifconfig ${ETH} down

- command:
    name: j17_off

##################
# J21
##################
- command:
    name: j21_on

- test:
    timeout:
      minutes: 30
    interactive:
    - name: j21
      prompts: [root@snarc-soca9, root@rzn1-snarc]
      script:
      - command: ETH=eth1
      - command: ifconfig -a
      - command: ip addr show
      - command: ip addr show ${ETH}
      - command: nmcli -c no -t connection show
      - command: 'nmcli -c no -t connection show | grep ${ETH} | cut -d: -f1'
      - command: 'ID=$(nmcli -c no -t connection show | grep ${ETH} | cut -d: -f1)'
      - command: echo ID=${ID}
      - command: nmcli -c no -t connection show id "${ID}" | grep autoconn
      - command: nmcli device
      - command: nmcli -c no -t device
      - command: nmcli -c no -t device show
      - command: nmcli -c no -t device show ${ETH}
      - command: nmcli device set ${ETH} managed yes autoconnect yes
      - command: ifconfig ${ETH} up
      - command: ""
      - command: ""
      - command: sleep 10
      - command: ""
      - command: ""
      - command: ip addr show ${ETH}
      - command: ""
      - command: ""
      - command: nmcli -c no -t device show ${ETH}
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: echo "1 minute..."
      - command: ip addr show ${ETH}
      - command: nmcli -c no -t device show ${ETH}
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: echo "2 minutes..."
      - command: ip addr show ${ETH}
      - command: nmcli -c no -t device show ${ETH}
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: echo "3 minutes..."
      - command: ip addr show ${ETH}
      - command: nmcli -c no -t device show ${ETH}
      - command: ping -I ${ETH} -c 3 10.0.0.2
      - command: ping -I ${ETH} -c 3 10.0.33.20
      - command: ping -I ${ETH} -c 3 github.com
      - command: ifconfig ${ETH} down

- command:
    name: j21_off

##################
# eth0 switch
##################
- test:
    timeout:
      minutes: 10
    interactive:
    - name: eth0-switch
      prompts: [root@snarc-soca9, root@rzn1-snarc]
      script:
      - command: ETH=eth0
      - command: ifconfig -a
      - command: ip addr show
      - command: ifconfig ${ETH}
      - command: ip addr show ${ETH}
      - command: ifconfig ${ETH} up
      - command: ""
      - command: ""
      - command: sleep 10
      - command: ""
      - command: ""
      - command: ip addr show ${ETH}
      - command: ""
      - command: ""
      - command: sleep 10
      - command: ""
      - command: ""
      - command: ip addr show ${ETH}


##################
# J22
##################
- command:
    name: j22_on

- test:
    timeout:
      minutes: 30
    interactive:
    - name: j22
      prompts: [root@snarc-soca9, root@rzn1-snarc]
      script:
      - command: ETH=lan0
      - command: ifconfig -a
      - command: ip addr show
      - command: ip addr show ${ETH}
      - command: nmcli -c no -t connection show
      - command: 'nmcli -c no -t connection show | grep ${ETH} | cut -d: -f1'
      - command: 'ID=$(nmcli -c no -t connection show | grep ${ETH} | cut -d: -f1)'
      - command: echo ID=${ID}
      - command: nmcli -c no -t connection show id "${ID}" | grep autoconn
      - command: nmcli device
      - command: nmcli -c no -t device
      - command: nmcli -c no -t device show
      - command: nmcli -c no -t device show ${ETH}
      - command: nmcli device set ${ETH} managed yes autoconnect yes
      - command: ifconfig ${ETH} up
      - command: ""
      - command: ""
      - command: sleep 10
      - command: ""
      - command: ""
      - command: ip addr show ${ETH}
      - command: ""
      - command: ""
      - command: nmcli -c no -t device show ${ETH}
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: echo "1 minute..."
      - command: ip addr show ${ETH}
      - command: nmcli -c no -t device show ${ETH}
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: echo "2 minutes..."
      - command: ip addr show ${ETH}
      - command: nmcli -c no -t device show ${ETH}
      - command: ping -I ${ETH} -c 3 10.0.0.2
      - command: ping -I ${ETH} -c 3 10.0.33.20
      - command: ping -I ${ETH} -c 3 10.128.64.1
      - command: ping -I ${ETH} -c 3 github.com
      - command: ifconfig ${ETH} down

- command:
    name: j22_off

##################
# J23
##################
- command:
    name: j23_on

- test:
    timeout:
      minutes: 30
    interactive:
    - name: j23
      prompts: [root@snarc-soca9, root@rzn1-snarc]
      script:
      - command: ETH=lan1
      - command: ifconfig -a
      - command: ip addr show
      - command: ip addr show ${ETH}
      - command: nmcli -c no -t connection show
      - command: 'nmcli -c no -t connection show | grep ${ETH} | cut -d: -f1'
      - command: 'ID=$(nmcli -c no -t connection show | grep ${ETH} | cut -d: -f1)'
      - command: echo ID=${ID}
      - command: nmcli -c no -t connection show id "${ID}" | grep autoconn
      - command: nmcli device
      - command: nmcli -c no -t device
      - command: nmcli -c no -t device show
      - command: nmcli -c no -t device show ${ETH}
      - command: nmcli device set ${ETH} managed yes autoconnect yes
      - command: ifconfig ${ETH} up
      - command: ""
      - command: ""
      - command: sleep 10
      - command: ""
      - command: ""
      - command: ip addr show ${ETH}
      - command: ""
      - command: ""
      - command: nmcli -c no -t device show ${ETH}
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: echo "1 minute..."
      - command: ip addr show ${ETH}
      - command: nmcli -c no -t device show ${ETH}
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: echo "2 minutes..."
      - command: ip addr show ${ETH}
      - command: nmcli -c no -t device show ${ETH}
      - command: ping -I ${ETH} -c 3 10.0.0.2
      - command: ping -I ${ETH} -c 3 10.0.33.20
      - command: ping -I ${ETH} -c 3 10.128.64.1
      - command: ping -I ${ETH} -c 3 github.com
      - command: ifconfig ${ETH} down

- command:
    name: j23_off

##################
# J24
##################
- command:
    name: j24_on

- test:
    timeout:
      minutes: 30
    interactive:
    - name: j24
      prompts: [root@snarc-soca9, root@rzn1-snarc]
      script:
      - command: ETH=lan2
      - command: ifconfig -a
      - command: ip addr show
      - command: ip addr show ${ETH}
      - command: nmcli -c no -t connection show
      - command: 'nmcli -c no -t connection show | grep ${ETH} | cut -d: -f1'
      - command: 'ID=$(nmcli -c no -t connection show | grep ${ETH} | cut -d: -f1)'
      - command: echo ID=${ID}
      - command: nmcli -c no -t connection show id "${ID}" | grep autoconn
      - command: nmcli device
      - command: nmcli -c no -t device
      - command: nmcli -c no -t device show
      - command: nmcli -c no -t device show ${ETH}
      - command: nmcli device set ${ETH} managed yes autoconnect yes
      - command: ifconfig ${ETH} up
      - command: ""
      - command: ""
      - command: sleep 10
      - command: ""
      - command: ""
      - command: ip addr show ${ETH}
      - command: ""
      - command: ""
      - command: nmcli -c no -t device show ${ETH}
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: echo "1 minute..."
      - command: ip addr show ${ETH}
      - command: nmcli -c no -t device show ${ETH}
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: sleep 10
      - command: echo "2 minutes..."
      - command: ip addr show ${ETH}
      - command: nmcli -c no -t device show ${ETH}
      - command: ping -I ${ETH} -c 3 10.0.0.2
      - command: ping -I ${ETH} -c 3 10.0.33.20
      - command: ping -I ${ETH} -c 3 10.128.64.1
      - command: ping -I ${ETH} -c 3 github.com
      - command: ifconfig ${ETH} down

- command:
    name: j24_off

##################
# Finished
##################
- command:
    name: j21_on
